var datatables_spanish = {
    "sProcessing": "Procesando...",
    "sLengthMenu": "Mostrar _MENU_ registros",
    "sZeroRecords": "No se encontraron resultados",
    "sEmptyTable": "Ningún dato disponible en esta tabla",
    "sInfo": "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
    "sInfoEmpty": "Mostrando registros del 0 al 0 de un total de 0 registros",
    "sInfoFiltered": "(filtrado de un total de _MAX_ registros)",
    "sInfoPostFix": "",
    "sSearch": "Buscar:",
    "sUrl": "",
    "sInfoThousands": ",",
    "sLoadingRecords": "Cargando...",
    "oPaginate": {
        "sFirst": "Primero",
        "sLast": "Último",
        "sNext": "Siguiente",
        "sPrevious": "Anterior"
    },
    "oAria": {
        "sSortAscending": ": Activar para ordenar la columna de manera ascendente",
        "sSortDescending": ": Activar para ordenar la columna de manera descendente"
    }
};

var opciones = function () {
    return '<td>' +
        '<button type="button" class="btn btn-success glyphicon glyphicon glyphicon-shopping-cart" data-toggle="tooltip" data-placement="top" title="Vender"></button> ' +
        '<button type="button" class="btn btn-info glyphicon glyphicon-edit" data-toggle="tooltip" data-placement="top" title="Editar"></button> ' +
        '<button type="button" class="btn btn-warning glyphicon glyphicon-transfer" data-toggle="tooltip" data-placement="top" title="Traspaso"></button> ' +
        '<button type="button" class="btn btn-danger glyphicon glyphicon-trash" data-toggle="tooltip" data-placement="top" title="Eliminar"></button>' +
        '</td>';
}
$('[data-toggle="tooltip"]').tooltip();
$(document).ready(function () {
    var tabla = $("#tablaSmartphones").DataTable({
        "ajax": {
            "url": "/smartphone/lista",
            "dataSrc": ""
        },
        "columns": [
            {"data": "marca"},
            {"data": "modelo"},
            {"data": "descripcion"},
            {"data": "color"},
            {"data": "precio"},
            {"data": "cantidad"},
            {
                data: null,
                className: "center",
                defaultContent: opciones()
            }
        ],
        'language': datatables_spanish,
        'aoColumnDefs': [{'bSortable': false, 'aTargets': [6]}]
    });

    $("#tablaSmartphones").on("click", ".btn-warning", function () {
        var datos = tabla.row($(this).parents("tr")).data();
        var texto = datos.marca + " " + datos.modelo + " $" + datos.precio;

        swal({
                title: "¿Desea solicitar este Smarphone a la otra tienda?",
                text: texto,
                type: "warning",
                showCancelButton: true,
                confirmButtonColor: "#7DCEA0",
                confirmButtonText: "Si, estoy seguro",
                closeOnConfirm: false
            }
            , function () {
                $.post("http://localhost:8080/traspaso/registrar",
                    {
                        modelo: datos.modelo,
                        marca: datos.marca

                    }, function (data) {
                        if (data==true){
                            $.post("/traspaso/registrar",
                                {id:datos.idSmartphone},
                                function () {
                                    tabla.ajax.reload();
                                    swal("Se ha realizado el traspaso","Se ha aumentado las existencias en uno","success");
                                }
                            );
                        }else {
                            swal("No hay existencias en la otra tienda","","warning");

                        }
                    });
            });

    });


    $("#tablaSmartphones").on("click", ".btn-success", function () {
        var datos = tabla.row($(this).parents("tr")).data();
        var texto = datos.marca + " " + datos.modelo + " $" + datos.precio;
        if (datos.cantidad > 0) {
            swal({
                    title: "¿Esta seguro de Registrar esta Venta?",
                    text: texto,
                    type: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#7DCEA0",
                    confirmButtonText: "Si, estoy seguro",
                    closeOnConfirm: false
                }
                , function () {
                    $.post("/venta/registrar",
                        {
                            idSmartphone: datos.idSmartphone,
                            usuario: ''
                        },
                        function () {
                            tabla.ajax.reload();
                            swal("!Exito al registrar la Venta¡", "", "success");
                        }
                    );
                });
        } else {
            swal("¡No hay existencias!", "Es necesario abastecer el inventario", "warning");
        }
    });


    $("#tablaSmartphones").on("click", ".btn-info", function () {
        var datos = tabla.row($(this).parents("tr")).data();
        $("#modalTitulo").html("Actualizar Smartphone");
        $("#btnGuardar").html("Actualizar");
        $("#inputMarca").val(datos.marca);
        $("#inputModelo").val(datos.modelo);
        $("#inputDescripcion").val(datos.descripcion);
        $("#inputColor").val(datos.color);
        $("#inputPrecio").val(datos.precio);
        $("#inputCantidad").val(datos.cantidad);
        $("#inputID").val(datos.idSmartphone);
        $("#modalRegistro").modal("show");
    });

    $("#tablaSmartphones").on("click", ".btn-danger", function () {
        var datos = tabla.row($(this).parents("tr")).data();
        var texto = datos.marca + " " + datos.modelo + " $" + datos.precio;
        swal({
                title: "¿Estas seguro de eliminar?",
                text: texto,
                type: "warning",
                showCancelButton: true,
                confirmButtonColor: "#DD6B55",
                confirmButtonText: "Si, estoy seguro",
                closeOnConfirm: false
            },
            function () {
                $.post("/smartphone/eliminar",
                    {id: datos.idSmartphone}
                    , function () {
                        tabla.ajax.reload();
                        swal("¡Se ha eliminado!", "El smartphone se ha eliminado.", "success");
                    });
            });
    });

    $("#btnAgregar").click(function () {
        $("#modalTitulo").html("Registrar Smartphone");
        $("#btnGuardar").html("Agregar");
        $("#inputMarca").val("");
        $("#inputModelo").val("");
        $("#inputDescripcion").val("");
        $("#inputColor").val("");
        $("#inputPrecio").val("");
        $("#inputCantidad").val("");
        $("#inputID").val(null);
        $("#modalRegistro").modal("show");
    });

    $("#btnGuardar").click(function () {
        var marca = $("#inputMarca").val();
        var modelo = $("#inputModelo").val();
        var descripicion = $("#inputDescripcion").val();
        var color = $("#inputColor").val();
        var precio = $("#inputPrecio").val();
        var cantidad = $("#inputCantidad").val();
        var id = $("#inputID").val();

        if (marca == "" || modelo == "" || descripicion == "" || color == "" || precio == "" || cantidad == "") {
            swal("Advertencia", "Por favor llene todos los campos", "error");
        } else {
            var smartphone = {
                "idSmartphone": id,
                "marca": marca,
                "modelo": modelo,
                "descripcion": descripicion,
                "color": color,
                "precio": precio,
                "cantidad": cantidad
            };

            $.post("/smartphone/guardar",
                {
                    "idSmartphone": id,
                    "marca": marca,
                    "modelo": modelo,
                    "descripcion": descripicion,
                    "color": color,
                    "precio": precio,
                    "cantidad": cantidad
                },
                function () {
                    if (id == "") {
                        swal("¡Éxito!", "Se ha agregado un nuevo smartphone", "success");
                    } else {
                        swal("¡Éxito!", "Se ha actualizado el smartphone", "success");
                    }
                    tabla.ajax.reload();
                    $("#modalRegistro").modal("hide");

                });
        }
    });
});
